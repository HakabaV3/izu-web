<script>
	(function() {
		'use strict';

		var scriptURL = document.currentScript.ownerDocument.URL.replace(/\/[^\/]+$/, '/Store.js');

		var Flux = {},
			worker = new Worker(scriptURL),
			storeMap = new Map(),
			actionListenerMap = new Map(),
			flagRequestDispatch = false,
			dispatchStoreList = [];

		self.storeMap = storeMap;
		self.actionListenerMap = actionListenerMap;


		worker.addEventListener('message', function(ev) {
			var store = storeMap.get(ev.data.scriptUrl);
			if (!store) return;

			store.state = ev.data.state;
			requestDispatch(store);
		});


		//View側


		Flux.removeListener = function(scriptUrl, fn) {
			var store = storeMap.get(scriptUrl);
			if (!store) return;

			var listeners = store.listeners,
				max = listeners.length,
				i;

			for (i = 0; i < max; i++) {
				if (listeners[i] !== fn) continue;
				listeners.slice(i, 1);
				i--;
				max--;
			}

			return Flux;
		};

		Flux.dispatchAction = function(action, data) {
			worker.postMessage({
				type: 'action',
				action: action,
				data: data
			});

			return Flux;
		};


		//Store側


		Flux.addStore = function(scriptUrl, updateHandler) {
			var store = storeMap.get(scriptUrl);

			if (!store) {
				store = {
					scriptUrl: scriptUrl,
					state: {},
					listeners: [],
					flagRequestDispatch: false
				};
				storeMap.set(scriptUrl, store);

				worker.postMessage({
					type: 'store_add',
					scriptUrl: store.scriptUrl
				});
			}

			store.listeners.push(updateHandler);

			return Flux;
		};

		function requestDispatch(store) {
			if (!store.flagRequestDispatch) {
				dispatchStoreList.push(store);
				store.flagRequestDispatch = true;
			}

			if (flagRequestDispatch) return;
			flagRequestDispatch = true;

			requestAnimationFrame(function() {
				dispatchStoreList.forEach(function(store) {
					store.listeners.forEach(function(listener) {
						listener(store.state);
					});
					store.flagRequestDispatch = false;
				});

				dispatchStoreList = [];
				flagRequestDispatch = false;
			});
		}

		self.Flux = Flux;
	})()

</script>
