<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/components/tl-Overlay/tl-Overlay.html">
<link rel="import" href="/service/tl-animation/tl-animation.html">

<dom-module name="tl-IncSearch">
	<link rel="import" type="css" href="./tl-IncSearch.css">
	<template>

		<ul id="inlineChips" class="Chips Chips-inline" on-click="setFocus">
			<template is="dom-repeat" items="[[models]]" filter="filterIsSelected" observe="selected">
				<li class="Chip">
					<span class="Chip-text">[[item.value]]</span>
				</li>
			</template>
		</ul>

		<tl-overlay id="overlay">
			<div id="overlayBase">
				<ul class="Chips">
					<template is="dom-repeat" items="[[models]]" filter="filterIsSelected" observe="selected">
						<li class="Chip">
							<span class="Chip-text">[[item.value]]</span>
						</li>
					</template>
				</ul>
				<div id="card">
					<ul id="Candidates" class="Candidates">
						<template is="dom-repeat" items="[[models]]">
							<li class="Candidate" on-click="onItemClicked" selected$="[[item.selected]]">
								<span class="Candidate-text">[[item.value]]</span>
							</li>
						</template>
					</ul>
				</div>
			</div>
		</tl-overlay>

	</template>

	<script>
		/* global Polymer, kn */
		/* eslint no-unused-vars: [0] */

		'use strict';

		Polymer({
			is: 'tl-IncSearch',
			properties: {
				items: {
					type: Array,
					value: (function() {
						return [];
					}),
					observer: 'onItemChange'
				},
				models: {
					type: Array,
					readonly: true,
					value: (function() {
						return [];
					})
				},
				selectedItems: {
					type: Array,
					readonly: true
				}
			},
			ready: function() {
				this.$.overlay.delegate = this;
			},


			// Focus
			setFocus: function() {
				this.focus = true;
				this.$.overlay.open();
			},

			// Overlay


			adjustPosition: function() {
				var gcr = this.getBoundingClientRect(),
					overlayBase = this.$.overlayBase;

				overlayBase.style.top = gcr.top + 'px';
				overlayBase.style.left = gcr.left + 'px';
				overlayBase.style.width = gcr.width + 'px';
			},

			startOpeningAnimation: function() {
				this.adjustPosition();
				this.$.card.classList.add('is-opening');
				this.$.inlineChips.classList.add('is-hide');

				return 400;
			},
			endOpeningAnimation: function() {
				this.$.card.classList.remove('is-opening');
			},
			startClosingAnimation: function() {
				this.$.card.classList.add('is-closing');

				return 400;
			},
			endClosingAnimation: function() {
				this.$.inlineChips.classList.remove('is-hide');
				this.$.card.classList.remove('is-closing');
			},


			// Item data


			onItemChange: function() {
				/**
				 * @TODO
				 * アイテムを追加するとそれまでの選択状態が初期化されてしまう。
				 * IDなどを降ることで、差分のみ追加するシステムに
				 */
				this.initializeModels();
			},
			initializeModels: function() {
				this.set('models', this.items.map(function(item) {
					return {
						value: item,
						selected: false
					}
				}));
			},
			onItemClicked: function(ev) {
				var model = ev.model;
				this.set('models.' + model.index + '.selected', !model.item.selected);
				this.fire('change', {
					index: model.index,
					model: model.item
				});
			},
			filterIsSelected: function(item) {
				return item.selected;
			}
		});

	</script>
</dom-module>
