machine:
   environment:
      CLOUDSDK_CORE_DISABLE_PROMPTS: 1
   services:
      - docker
   node:
      version: 4.1.0
dependencies:
   pre:
      - npm install -g npm
      - npm install -g gulp
      - npm install -g bower
      - curl https://sdk.cloud.google.com | bash
      - gcloud config set --scope=user disable_usage_reporting true
      - gcloud components update preview
      - gcloud components update kubectl
      - gcloud auth activate-service-account 589659287962-rl8f27hfj6kg35b2vvkt14n4ci12h1md@developer.gserviceaccount.com --key-file dev-credential.json
      - gcloud container clusters get-credentials airprobe --zone=asia-east1-a --project=airprobe-0
      - mkdir tmp
   override:
      - rm -rf node_modules
      - npm install
      - npm rebuild node-sass
      - bower install
      - gulp build
   post:
      - docker build -t asia.gcr.io/airprobe_0/web-console:$CIRCLE_BRANCH-$CIRCLE_BUILD_NUM .
test:
   override:
      - docker run -d -p 80:80 asia.gcr.io/airprobe_0/web-console:$CIRCLE_BRANCH-$CIRCLE_BUILD_NUM; sleep 10
      - curl --retry 10 --retry-delay 5 -v http://localhost
deployment:
   test:
      branch: dev
      commands:
         - gcloud config set project airprobe-0
         - gcloud docker push asia.gcr.io/airprobe_0/web-console:$CIRCLE_BRANCH-$CIRCLE_BUILD_NUM
         - kubectl rolling-update web-console --image=asia.gcr.io/airprobe_0/web-console:$CIRCLE_BRANCH-$CIRCLE_BUILD_NUM
